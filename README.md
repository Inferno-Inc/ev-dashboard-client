# EV Dashboard Client v0.1

## Disclaimer
> The EV Dashboard Client is not ready for production grade applications.

## Introduction
This repository provides apps and libraries to allow users and assets/devices to register in the ev-dashboard registry and obtain credentials for participation in a flexibility market.

This repository also provides documentation on the steps required to connect to the EV Dashboard.

## Connecting to the EV Dashboard
The EV Dashboard is an application which aggregates OCPI data (via the OCN) and Blockchain data for both EVs and charge points. It also facilitate the request and issuance process for credentials relating to a flexibility market. The steps needed to access the EV Dashboard and list your devices are details below.

### OCN Connection
The EV Dashboard Backend retrieves vehicle and chargepoint data from CPO and eMSP backends
via OCPI connections routed by the OCN.
In order to create an OCN connection to the EV Dashboard Backend, the following steps are required:
1. Connect to an OCN Node
2. Whitelist the EV Dashboard Backend (see the OCN Rules section of the [OCN Node Documentation](https://shareandcharge.bitbucket.io/)).
3. Agree to the service permissions (see "Agree to service permissions" section of [ocn-registry cli docs](https://bitbucket.org/shareandcharge/ocn-registry/src/master/))

### Registration in the EV Registry smart contract
The EV Registry smart contract is a registry of both users and devices (vehicles or chargepoints) which have agreed to participate in the EV Dashboard and the associated flexibility market.
Therefore, both users and devices can be registered and both are represented by a Volta address.
Devices are registered by a user (they cannot register themselves) and are associated to that user.

The steps for registration are:
1. Register as a user.
In order to register, you must first be listed a party in the OCN Registry smart contract. To register, you can use the `add-user` command of the [asset-operator-cli](#asset-operator-cli)

2. (Optional) Create device keypairs.
In order for a device to be registered in the EV Registry, they must have a Volta address.
New addresses with their associated private keys can be generated by using the `generate-key` command of the the [asset-operator-cli](#asset-operator-cli)

3. Register devices.
This can be done using the using the `add-device` command of the the [asset-operator-cli](#asset-operator-cli) 

### Sign into the EV Dashboard
As a CPO or eMSP, you can sign into the EV Dashboard in order to view your vehicles or chargepoints
and request prequalification credentials on their behalf.
In order to register as a CPO or eMSP, you need to obtain a verified credential of your respective role. This registration is done via the EnergyWeb Switchboard application. The Switchboard documentation on this process is available [here](https://energyweb.atlassian.net/wiki/spaces/SWITCH/pages/1712554033/Using+Switchboard#V.-Enrolments). In the case of the EV dashboard, this process can be initiated from the EV Dashboard login page.
At a high level the process is:
- Request a credential
- Get approval
- Add credential to your DID document

### Listening for prequalification requests


## App Usage

The two apps which are available are the [asset-operator-server](#asset-operator-server)
and the [asset-operator-cli](#asset-operator-cli).

### Running asset-operator-cli

The `asset-operator-cli` can be installed by running `npm i -g @energyweb/ev-asset-operator-cli`

#### Add a user

This command will register the OCN party corresponding to
the private key as a user in the ocn registry

```
ev-cli add-user \
 --operator-key <private key of OCN party> \
 --ev-registry-address <address of EV registry> \
 --provider-url <RPC url>
```

#### Generate device keypair

This command will generate a sqlite db file named `keymanager.db`
if it doesn't exist and will generate a keypair with an address and private key.

```
ev-cli generate-key
```

#### Add a device 

This command will register the device to the party corresponding to
the private key.
The device UID can be for example an OCPI token UID or an OCPI evse ID. 

```
ev-cli add-device \
 --operator-key <private key of OCN party> \
 --ev-registry-address <address of EV registry> \
 --provider-url <RPC url> \
 --device-address <the address from generate-key. Only address, not with did method> \
 --device-uid <the OCPI uid of the device>
```
Example:
```
ev-cli add-device \
 --operator-key 424b82cb3f4c74a975c209192c4b6867a0d9294a0dd41dd83b468fe0d0c634da \
 --ev-registry-address 0xacbcC4db79893CDA1714795Ce26686EEb7D85E5C \
 --provider-url https://volta-rpc.energyweb.org \
 --device-address 0x95caf3C2aBa58497ea2381Fdc1D7D09deC41C620 \
 --device-uid 123456 
```

#### Hydrate a device DID document

This command will transfer some tokens from the operator to the device account
and "create" the device's DID document (i.e. will add the device's public key to the document).

```
ev-cli create-document \
 --operator-key <private key of account with funds for device account> \
 --did-registry-address <address of DID registry> \
 --provider-url <RPC url> \
 --transfer-amount <The amount of Volta token or EWT to transfer to the asset> \
 --device-did <the DID of the device. The private key for this DID should be available in `keymanager.db`>
 ```
 Example:
```
ev-cli create-document \
 --operator-key 424b82cb3f4c74a975c209192c4b6867a0d9294a0dd41dd83b468fe0d0c634da \
 --did-registry-address 0xc15d5a57a8eb0e1dcbe5d88b8f9a82017e5cc4af \
 --provider-url https://volta-rpc.energyweb.org \
 --transfer-amount 0.001 \
 --device-did did:ethr:0x90052544A684935E3D5Ede4741505e332770E5D7
 ``` 

 #### Add claim to DID document

 This command will issue a credential signed by the `operator-key` and retrieves the key associated
 with the device DID from the `keymanager.db` to add the claim to the device's DID document.
 The credential will contain a claim regarding the `data-endpoint` parameter.

```
ev-cli add-claim \
 --operator-key <private key of account with funds for device account> \
 --did-registry-address <address of DID registry> \
 --provider-url <RPC url> \
 --data-endpoint <The endpoint to include in the claim> \
 --device-did <the DID of the device. The private key for this DID should be available in `keymanager.db`>
 ```
 Example:
```
ev-cli add-claim \
 --operator-key 424b82cb3f4c74a975c209192c4b6867a0d9294a0dd41dd83b468fe0d0c634da \
 --did-registry-address 0xc15d5a57a8eb0e1dcbe5d88b8f9a82017e5cc4af \
 --provider-url https://volta-rpc.energyweb.org \
 --data-endpoint http://device-manufacturer/#did:ethr:0x90052544A684935E3D5Ede4741505e332770E5D7 \
 --device-did did:ethr:0x90052544A684935E3D5Ede4741505e332770E5D7
 ``` 


### Running asset-operator-server

The `asset-operator-server` can be installed by running `npm i -g @energyweb/ev-asset-operator-server`

Several configuration values are required to run the app. Please request these values as necessary.

Once the app is built and the configuration has been provided, the app can be run by executing:
```
cd apps/asset-operator-server
pnpm start
```

## Architecture Diagram

![EV Dashboard Client Architecture](https://github.com/energywebfoundation/ev-dashboard-client/blob/master/architecture.png)

## Component Descriptions

### Apps

#### asset-operator-server
A node express HTTP server which bundles and operator the client libraries.

#### asset-operator-cli
A javascript cli which allows reading and writing to EV Registry smart contract as well as
generating keypairs for devices.

### Libraries

#### did-hydrator

Perform operations on a device's DID and Credentials:
- Create a DID Document and fund the asset's EWC account
- Issue a credential and add as a service endpoint in the DID document

#### asset-registrar

Registers an asset or user in the `ev-registry` smart contract

#### prequalification-client

Listens for NATS events regarding prequalification credentials and handles them on behalf of asset(s).

#### signer-provider-interface

An interface which provides access to a Signer for a given DID

### Databases

#### key-manager

Optional component that can be used to centrally manage keys.
Implements `signer-provider-interface`.
Can generate a new address/key-pair and well as provide existing key-pairs.

## Development

This repository is a monorepo that uses [Rush](https://rushjs.io/) with the PNPM package manager.

PNPM is used for its speed and solution to NPM doppelgangers (as well as being the default option for rush). See comparison of [NPM vs PNPM vs Yarn for Rush](https://rushjs.io/pages/maintainer/package_managers/).

### Install PNPM and Rush

PNPM is required. See installation instructions here: https://pnpm.js.org/installation/

Rush is required. See installation instructions here: https://rushjs.io/pages/intro/get_started/

### Installing Dependencies

Use rush to install dependencies (not the package manager directly).
In other words, do not run `npm install` or `pnpm install`.
This is because [Rush optimizes](https://rushjs.io/pages/developer/new_developer/) by installing all of the dependency packages in a central folder, and then uses symlinks to create the “node_modules” folder for each of the projects.

```sh
$ rush install
```

### Compile & Build

Use rush to build.

```sh
$ rush build
```

### Linting and Formating

This repository use ESLint for code conventions and Prettier for syntax formatting.
Both are setup according to [Rush recommendations](https://rushjs.io/pages/maintainer/enabling_prettier/):
- ESLint is configured per project while Prettier is configured globally.
- Prettier is configured to run as a pre-commit hook.

### Publishing new version

Steps are currently:
1. Run `rush change` manually to generate change files
2. Run `rush version --bump` to convert change files to changelog entries and update package.json versions
3. Merge to `publish` branch to trigger publishing via GitHub actions